<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>custom\generator.js - diplomka</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="diplomka" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ANL.html">ANL</a></li>
                                <li><a href="../classes/Client.html">Client</a></li>
                                <li><a href="../classes/Cluster.html">Cluster</a></li>
                                <li><a href="../classes/ClusterHandler.html">ClusterHandler</a></li>
                                <li><a href="../classes/DataTraffic.html">DataTraffic</a></li>
                                <li><a href="../classes/Generator.html">Generator</a></li>
                                <li><a href="../classes/MasterRequest.html">MasterRequest</a></li>
                                <li><a href="../classes/Node.html">Node</a></li>
                                <li><a href="../classes/PingHandler.html">PingHandler</a></li>
                                <li><a href="../classes/Request.html">Request</a></li>
                                <li><a href="../classes/RespondObject.html">RespondObject</a></li>
                                <li><a href="../classes/SampleReader.html">SampleReader</a></li>
                                <li><a href="../classes/Settings.html">Settings</a></li>
                                <li><a href="../classes/UsersStorage.html">UsersStorage</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Authentification.html">Authentification</a></li>
                                <li><a href="../modules/Custom.html">Custom</a></li>
                                <li><a href="../modules/DNAAnalysis.html">DNAAnalysis</a></li>
                                <li><a href="../modules/JDSM.html">JDSM</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: custom\generator.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Static class with methods of creating fixture data.
 * @class Generator
 * @module Custom
 */
var Models = require(&#x27;../models&#x27;),
    Q = require(&#x27;q&#x27;),
    _ = require(&#x27;underscore&#x27;),
    Sequelize = require(&#x27;sequelize&#x27;),
    fs = require(&#x27;fs&#x27;);
module.exports = (function() {

  /**
   * Object with static settings for class.
   * @property settings
   * @type {Object}
   */
  var settings = {
    patientName: &#x27;Generator&#x27;,
    additionalInfo: &#x27;Generated Sample for patterns: &#x27;,
    nucleotidSigns: [&#x27;C&#x27;, &#x27;G&#x27;, &#x27;T&#x27;, &#x27;A&#x27;]
  }

  /**
   * Creates control string for sequence with chromosome (0-indexed!!!) and
   * sequence start position.
   * @method getControlString
   * @private
   * @param {integer} chromosome
   * @param {integer} sequenceStart
   * @returns {string}
   */
  var getControlString = function(chromosome, sequenceStart) {
    return &#x27;[&#x27;+(parseInt(chromosome)+1)+&#x27;:&#x27;+sequenceStart+&#x27;]&#x27;;
  }

  /**
   * Returns random nucleotid sign. (C || G || T || A)
   * @method getRandomNucleotid
   * @private
   * @returns {char}
   */
  var getRandomNucleotid = function() {
    return settings.nucleotidSigns[Math.floor(Math.random()*4)];
  }

  /**
   * Create random DNA sequence of specified length.
   * @method getRandomSequence
   * @private
   * @param {integer} length
   * @returns {string}
   */
  var getRandomSequence = function(length) {
    var res = &#x27;&#x27;;
    for (var i = 0; i &lt; length; i++) {
      res += getRandomNucleotid();
    }
    return res;
  }

  /**
   * Cluster patterns into array of arrays, where every index represents
   * chromosome (0-indexed). Patterns in chromosome are sorted.
   * @method clusterPatternsByChromosomes
   * @param {Models.Pattern[]} patterns
   * @returns {Pattern[][]}
   */
  var clusterPatternsByChromosomes = function(patterns) {
    //cluster patterns by chromosome and sort them by sequenceStart
    var chromosomes = (function(){
      var res = [];
      for (var i=0, len=23; i&lt;len;i++)
        res.push(new Array());
      return res;
    })();

    _.each(patterns, function(pattern) {
      chromosomes[pattern.chromosome - 1].push(pattern);
    });

    _.each(chromosomes, function(chromosomeArray) {
      chromosomeArray.sort(function(a, b) {
        return a.sequenceStart - b.sequenceStart;
      });
    });
    return chromosomes;
  }

  /**
   * Generate minimal sequence for corret patterns.
   * @method generateSequence
   * @private
   * @throws Error(&#x27;Pattern collision&#x27;)
   * @param {Models.Pattern[]} patterns
   * @returns {string}
   */
  var generateSequence = function(patterns) {

    var getRealChromosomeResultLength = function() {
      return chromosomeResult.length - controlsLen;
    }

    var chromosomes = clusterPatternsByChromosomes(patterns);
    var result = &#x27;&#x27;;
    var start = 0;
    var chromosomeResult = &#x27;&#x27;;
    var controlsLen = 0;

    _.each(chromosomes, function(patternArray, index) {
      start = 0;
      chromosomeResult = &#x27;&#x27;;
      controlsLen = 0;
      if (patternArray.length &gt; 0) {
        chromosomeResult += getControlString(index, patternArray[0].sequenceStart);
        controlsLen = chromosomeResult.length;
        start = patternArray[0].sequenceStart;
      }
      _.each(patternArray, function(pattern) {
        //if part of pattern is in result - check if it is matched add rest of pattern into result otherwise throw error
        if (pattern.sequenceStart &lt; start + getRealChromosomeResultLength()) {
          var chResSub = chromosomeResult.substr(pattern.sequenceStart - start + controlsLen);
          var patternSub = pattern.data.substr(0, start + getRealChromosomeResultLength() - pattern.sequenceStart);
          if (chResSub !== patternSub)
            throw new Error(&#x27;Pattern collision&#x27;);

          chromosomeResult += pattern.data.substr(start + getRealChromosomeResultLength() - pattern.sequenceStart);
        }
        //if pattern starts at actual position of result, copy pattern into result
        else if (pattern.sequenceStart == start + getRealChromosomeResultLength()) {
          chromosomeResult += pattern.data;
        }
        //if pattern starts after position of result generate rand sequence and copy pattern
        else if (pattern.sequenceStart &gt; start + getRealChromosomeResultLength()) {
          chromosomeResult += getRandomSequence(pattern.sequenceStart - (start + getRealChromosomeResultLength()));
          chromosomeResult += pattern.data;
        }
      });
      result += chromosomeResult;
    });

    return result;
  }

  return {
    /**
     * Creates sample record for user defined by username and
     * positive for all patterns in patternIds array.
     * @method createSample
     * @param {string} username
     * @param {Integer[]} patternIds
     * @param {function(Sample)} callback
     */
    createSample: function(username, patternIds, callback) {
      //get patterns model instances for patternIds

      Q.all([
        Models.Pattern.findAll({
          where:{id:patternIds}
        }),
        Models.User.find({
          where: {username: username}
        })
      ]).then(function(results){
        var patterns = results[0];
        var user = results[1];
        var sequence = generateSequence(patterns);
        var tempPath = Math.floor(Math.random()*1000)+&#x27;.txt&#x27;;
        Q.all([
          Q.nfcall(fs.writeFile, tempPath, sequence, &#x27;utf-8&#x27;),
          Models.Sample.build({
            UserId: user.id,
            isDone: false,
            patientName: settings.patientName,
            additionalInfo: settings.additionalInfo + patternIds
          }).save()
        ]).then(function(results){
          var sample = results[1];
          var correctPath = &#x27;/samples/&#x27;+user.id+&#x27;_&#x27;+sample.id+&#x27;.dna&#x27;;
          Q.nfcall(fs.rename, tempPath, &#x27;./&#x27;+correctPath).then(function(){
            sample.dataPath = &#x27;.&#x27;+correctPath;
            sample.save().then(function(sample){
              callback(null, sample);
            });
          }).catch(function(err){
            callback(err);
          })
        }).catch(function(err){
          callback(err);
        })
      }).catch(function(err){
        callback(err);
      })
    },

    /**
     * Call private method generateSequence.
     * @method generateSequence
     * @param {Pattern[]}
     * @returns {string}
     */
    generateSequence: function(patterns) {
      return generateSequence(patterns);
    }
  }
})();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
